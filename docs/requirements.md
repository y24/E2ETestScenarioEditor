# 要件定義書：E2EFramework シナリオ（JSON）Web編集ツール

## 1. 目的・背景

### 1.1 目的

E2EFramework のテストシナリオ JSON ファイル（以下「シナリオファイル」）を、ローカル環境で起動した Web UI から簡単に作成・編集・保存できるようにする。
テストシナリオ開発の速度とミス耐性（編集ミス・構造破壊・保存事故）を改善する。

### 1.2 背景

* JSON を直接編集する運用は柔軟だが、階層構造・配列操作・複数ステップ編集・コピペなどでヒューマンエラーが起きやすい。
* ステップの並び替え、複数選択、挿入、無効化、グループ化などはテキスト編集だと事故率が高い。

### 1.3 スコープ

**対象**

* E2EFramework のシナリオ JSON の編集（読み込み/作成/保存/名前を付けて保存）
* setup / steps / teardown の3セクションに属するステップ配列の編集
* シナリオ基本情報（id, name, tags, description など）の編集
* ステップの編集（name, type, params, ignore ほか任意キー）
* ステップの複数選択操作（削除/複製/コピー/リネーム/無効化/グループ化）
* クリップボードによる JSON 形式のコピー＆ペースト（複数ステップ含む）

**対象外（初期リリースではやらない）**

* E2EFramework の実行・テストランナー機能
* スキーマ厳密バリデーション（軽量に警告程度は可）
* リモート共有・マルチユーザー同時編集
* Git 連携、差分ビュー、レビュー機能（将来拡張は可）
* 大規模なUIコンポーネントライブラリ前提の実装（例：巨大なSPAフレームワーク依存）

---

## 2. 用語

* **シナリオファイル**：E2EFramework 用の JSON ファイル
* **ステップ**：setup/steps/teardown の配列要素（オブジェクト）
* **セクション**：setup / steps / teardown のいずれか
* **グループ**：UI上で複数ステップを束ねる概念（JSONに保持する）
* **無効化**：ステップに `"ignore": true` を付与すること

---

## 3. 前提・制約

### 3.1 動作環境

* ローカルPCで起動し、`localhost` でブラウザアクセスして利用する。
* OSは Windows を優先（ただし可能ならクロスプラットフォーム）。

### 3.2 技術制約（軽量化）

* 「開発補助ツール」につき、不要に重いフロントエンド構成は避ける。
* サーバーは簡易（ローカル専用）。認証/認可は基本不要。
* JSONの未知キーを壊さず保持できる設計を必須とする（これが最重要）。

---

## 4. ユースケース（要約）

1. ツール実行 → ローカルサーバー起動 → ブラウザで編集画面へ
2. 初回起動時：`scenarios` と `scenarios_shared` のフォルダパスを設定
   次回以降：設定を読み込む（設定画面から変更可能）
3. フォルダ配下を再帰走査して JSON ファイル一覧を構築
   「親フォルダ名 / ファイル名 / シナリオname」で選択できる
4. 選択したシナリオをタブで開き、複数シナリオを同時編集
5. 左ペインで setup/steps/teardown のステップ一覧を表示（折り畳み可能）
6. ステップの追加・挿入・貼り付け・並び替え・複数選択操作・グループ化・無効化
7. 右ペインでステップ詳細（name/type/params/任意キー）を編集
8. シナリオ基本情報（id/name/tags/description）を編集
9. 保存 / 名前を付けて保存

---

## 5. 機能要件

### 5.1 起動・アクセス

* F-001：CLI等で実行すると HTTP サーバーが起動する。
* F-002：ブラウザで `http://localhost:<port>/` にアクセスするとUIが表示される。
* F-003：ポートはデフォルト値を持ち、衝突時は変更可能（起動引数や設定で）。
* F-004：ローカル専用（外部公開は想定しない）。必要なら `127.0.0.1` バインド。

### 5.2 設定（シナリオフォルダ）

* F-010：初回起動時に以下を設定できる

  * scenarios フォルダパス
  * scenarios_shared フォルダパス
* F-011：設定は永続化され、次回起動時に自動読み込みされる。
* F-012：設定画面で後から変更できる。
* F-013：設定されたフォルダ配下を再帰的にスキャンし、JSONファイル一覧を生成する。
* F-014：一覧は「親フォルダ名 / ファイル名 / シナリオname（JSON内）」を表示し、検索・絞り込みができる（軽量実装でよい）。
* F-015：ファイルの追加・削除・変更に対して一覧を更新できる（手動リロードでも良い。自動監視は任意）。

### 5.3 シナリオの読み込み・タブ管理

* F-020：一覧から選択したシナリオファイルを読み込んで編集できる。
* F-021：複数シナリオをタブで開ける。
* F-022：タブ切替で編集対象を切り替えられる。
* F-023：未保存変更がある場合、タブ切替/閉じる/別シナリオ読み込みで警告する。

### 5.4 シナリオ基本情報の編集

* F-030：シナリオの `id, name, tags, description` を編集できる。
* F-031：上記キーが存在しない場合でも編集UIが動作し、保存時に追加できる。
* F-032：tags は配列として編集できる（追加/削除/並び替えは任意、最低限追加削除）。

### 5.5 セクション（setup/steps/teardown）表示

* F-040：左ペインに setup, steps, teardown をセクションとして表示する。
* F-041：各セクションは折り畳み可能。
* F-042：setup/teardown がJSONに存在しない場合は「空」として扱い、必要なら追加できる。

### 5.6 ステップ一覧（左ペイン）

* F-050：各ステップの `name` と `type` を一覧表示する（ない場合はプレースホルダ表示）。
* F-051：クリックでステップを選択し、右ペインに詳細を表示する。
* F-052：複数選択できる（Ctrl/Shift相当の挙動、UIに合わせる）。
* F-053：ドラッグ＆ドロップでステップ順序を並び替えできる。
* F-054：選択したステップに対して以下操作ができる

  * 削除
  * 複製（同じ位置に挿入 or 直後に挿入）
  * コピー（クリップボードへ JSON として）
  * 名前変更（複数選択時は一括ルールを定義：例「末尾に(2)」など。実装負荷が高ければ単一選択のみ必須）
* F-055：ステップとステップの間にマウスオーバーで「+」操作が出る

  * 「ここにステップを挿入」（新規ステップ作成）
  * 「ここにステップを貼り付け」（クリップボードから貼り付け）
* F-056：複数ステップのコピー・貼り付けに対応する。
* F-057：コピーしたステップは別シナリオにも貼り付け可能。
* F-058：各ステップはツール管理用の識別子 `_stepId` を保持する

  * 読み込み時に `_stepId` が無いステップには自動採番して付与する
  * `_stepId` が重複している場合は重複分を再採番する
  * 複製・貼り付けで生成されたステップには新しい `_stepId` を採番する（コピー元のIDは引き継がない）

### 5.7 無効化（ignore）

* F-060：複数ステップを選択して無効化できる。
* F-061：無効化するとステップに `"ignore": true` を付与する。
* F-062：無効化を解除すると `ignore` キーを削除する（`false` を残さない）。
* F-063：無効化ステップはUI上で視認できる（グレーアウト・透過など）。

### 5.8 ステップ詳細（右ペイン）

* F-070：選択したステップの内容を編集できる。
* F-071：最低限 `name`, `type`, `params`, `ignore` を編集できる。
* F-072：ステップが持つ **任意のキー**（例：conditions など）も編集・保持できる。
* F-073：`params` は固定スキーマに依存せず、任意キーを編集できる（key-value編集UI）。
* F-074：利便性として `params.action` は

  * 文字列自由入力を許容
  * プルダウン選択も可能
  * action候補はアプリの設定ファイル等から読み込める
* F-075：編集UIは「破壊しない」ことを優先する（データ型を勝手に変えない、未知構造を潰さない）。

### 5.9 新規シナリオ作成

* F-080：新規シナリオファイルを作成できる。
* F-081：新規作成時、最低限 `{}` でも開始できる（必須項目なし）。
* F-082：保存時に保存先（scenarios or scenarios_shared 配下）とファイル名を指定できる。

### 5.10 保存・名前を付けて保存

* F-090：上書き保存ができる。
* F-091：「名前を付けて保存」ができる（別ファイルとして保存）。
* F-092：保存時に JSON の整形（pretty print）を行うか選べる（デフォルト整形でも可）。
* F-093：保存前後で、**元JSONに存在した未知キーや構造が保持される**。
* F-094：保存失敗時（権限/競合/不正JSONなど）に理由を表示する。
* F-095：保存時、トップレベルキーの出力順を固定する

  * 順序：`id`, `name`, `tags`, `description`, `setup`, `steps`, `teardown`, （その他の未知キー）, `_editor`
  * 「その他の未知キー」は値を保持し、`teardown` の後、`_editor` の前に出力する
    （未知キー同士の順序は“読み込み時の順”を可能な範囲で維持。難しければ安定ソートでも可だが、最低限値は保持する）

---

## 6. グループ化仕様（案B確定版）

### 6.1 要件（確定）

* G-001：複数ステップを選択して「グループ化」できる
* G-002：グループに名前（任意）を付けられる
* G-003：グループは折りたためる（collapsed状態を保持）
* G-004：グループ単位で並び替えできる（グループ内の相対順は維持）
* G-005：グループ化情報は `_editor` に保存され、再読み込みで復元される
* G-006：E2EFramework実行に影響を与えない（グループは **steps配列自体には構造を混ぜない**）

### 6.2 データモデル（確定）

#### 6.2.1 ステップ側（実データ）

各ステップオブジェクトに `_stepId` を付与する（ツール管理用）。

```json
{
  "name": "メモ帳を起動",
  "type": "system",
  "_stepId": "stp_01J...（自動採番）",
  "params": { "action": "start_app" }
}
```

#### 6.2.2 `_editor` 側（UIメタ）

* `_editor.version`：メタ仕様バージョン（初期値 1）
* `_editor.stepIdKey`：ステップ識別子キー名（固定で `_stepId`）
* `_editor.sections.<section>`：setup/steps/teardown ごとにレイアウトとグループを保持

**例（stepsにグループが1つある）**

```json
"_editor": {
  "version": 1,
  "stepIdKey": "_stepId",
  "sections": {
    "steps": {
      "layout": ["stp_a", "grp_1", "stp_d"],
      "groups": {
        "grp_1": {
          "name": "ログイン一式",
          "collapsed": true,
          "items": ["stp_b", "stp_c"]
        }
      }
    }
  }
}
```

**ルール**

* `layout` は UI 上の並び（グループも含む）を表す

  * 要素は **ステップID** または **グループID**（`groups` に存在するキー）
* 実行順（setup/steps/teardownの配列順）は、`layout` を **フラット化**した順序に一致させて保存する

  * `layout` に `grp_1` が出たら、その位置に `groups.grp_1.items` を展開する
* `groups.<gid>.items` は、そのグループに属するステップIDを **順序付きで**持つ
* setup/teardown についても同じ構造で持てる（存在しないセクションは持たなくてよい）

### 6.3 整合性・修復ポリシー（要件）

* G-100：`layout` や `groups` が壊れている/参照先ステップが無い場合、ツールは可能な範囲で自動修復する

  * 例：存在しないステップID参照は取り除く
  * 例：`layout` に存在しないステップは末尾に追加して見失わないようにする
* G-101：グループが空になった場合は自動削除する（UIメタが肥大化しないように）

---

## 7. データ保持・互換性要件（最重要）

* D-001：読み込んだ JSON の **未知キー/未知構造を完全保持**して保存できる。

  * 例：ステップが `conditions` や未知のネストを持っていても消えない
* D-002：編集UIが扱わない領域は “ラウンドトリップ” で変化しない（順序の変化は許容範囲を定義）
* D-003：配列/オブジェクト/数値/文字列/真偽/null の型を勝手に変換しない
* D-004：`ignore` は true 付与/キー削除のルールを厳守（false にしない）
* D-010：追加する管理キーは以下に限定

  * ステップ：`_stepId`
  * トップレベル：`_editor`
* D-011：コピー/貼り付け/複製での `_stepId` の扱い

  * 貼り付け・複製されたステップは必ず新しい `_stepId` を採番
  * これにより、同一ファイル内のID重複を防ぐ

---

## 8. 非機能要件

### 8.1 ユーザビリティ

* N-001：最小クリックで編集できる（一覧→選択→右で編集）。
* N-002：キーボードショートカット（任意）：コピー/貼り付け/削除/保存。

### 8.2 性能

* N-010：数百〜数千ファイル程度の一覧が実用になる（必要なら検索は遅延実行）。
* N-011：シナリオ1つあたりステップ数が多くても操作が破綻しない（例：数百ステップ）。

### 8.3 信頼性

* N-020：保存失敗時にデータ損失を避ける（テンポラリ保存やバックアップは任意だが推奨）。
* N-021：未保存検知と警告を必須とする。

### 8.4 セキュリティ（ローカル前提）

* N-030：外部アクセス前提の対策は最低限。ただしファイルパス操作は慎重に。
* N-031：フォルダ指定外の任意ファイルを編集できないようにする（パストラバーサル対策）。

### 8.5 保守性・拡張性

* N-040：action候補リストなどは設定ファイルで差し替え可能にする。
* N-041：UIメタ情報（グループ等）を拡張できる構造を持つ。

---

## 9. 画面要件（UI構成）

### 9.1 画面一覧

* 画面A：メイン編集画面（タブ/左一覧/右詳細）
* 画面B：設定画面（scenarios / scenarios_shared のパス設定、action候補リスト等）
* 画面C：新規作成/保存ダイアログ（保存先・ファイル名）

### 9.2 メイン編集画面レイアウト

* 上部：タブバー（開いているシナリオ）
* 左：セクション（setup/steps/teardown）＋ステップツリー/リスト
* 右：選択ステップの詳細編集
* シナリオ基本情報（id, name, tags, description）は 常時表示しない
* メイン画面には「シナリオ設定」ボタン（アイコンでも可）を配置し、クリックで モーダル（またはドロワー）を表示して編集する

### 画面仕様

* 画面A：メイン編集画面（タブ/左一覧/右詳細）
* 画面A-1：シナリオ設定モーダル

  * 編集対象：`id, name, tags, description`（存在しないキーは追加可能）
  * ボタン：

    * **適用**（モーダルを閉じる。シナリオ状態は「未保存」にする）
    * **キャンセル**（モーダル内変更を破棄して閉じる）
* 表示項目（推奨）：

  * 読み込み中のファイルパス（読み取り専用）
  * 現在の保存状態（未保存/保存済み）

### 操作要件

* UI-001：モーダル表示中に Esc で閉じられる（閉じる時に未適用変更があれば確認）
* UI-002：モーダルで「適用」しただけではファイル保存されない（保存は既存の保存操作に統一）
* UI-003：モーダル適用後、タブや画面遷移で未保存警告が出る（既存の未保存検知と同じ扱い）

---

## 10. 入出力・外部I/F

* I-001：入力はローカルファイルシステム上の JSON
* I-002：出力はローカルファイルシステム上の JSON（上書き/別名）
* I-003：action_reference.md から動的に仕様を解釈する必要はない（将来拡張）。
  初期は「action候補リストを設定ファイルで持つ」方式。

---

## 11. エラーハンドリング要件

* E-001：JSONパース失敗時、ファイルを開けない旨とエラー内容を表示する。
* E-002：保存先が書き込み不可の場合、理由を表示する。
* E-003：貼り付けJSONが不正/形式違いの場合、貼り付けを拒否し理由を表示する。
* E-004：編集中にファイルが外部変更された場合の扱いを定義（例：保存時に警告、または上書き確認）。

---

## 12. 受け入れ基準（抜粋）

* A-001：未知キーを含むシナリオを読み込み→何も変更せず保存しても、内容が失われない。
* A-002：複数ステップをコピーして別シナリオに貼り付けできる。
* A-003：ignore の付与/解除が要件通りに JSON に反映される。
* A-004：ドラッグ＆ドロップで並び替えた順序が保存される。
* A-005：グループ化した状態を保存し、再読み込みでUIが復元される。
* A-006：設定したフォルダパスが永続化され、再起動で復元される。

---

## 13. 保存時のキー順序

トップレベルJSONの出力順は以下：

1. `id`
2. `name`
3. `tags`
4. `description`
5. `setup`
6. `steps`
7. `teardown`
8. その他の未知キー（値保持、できれば元順維持）
9. `_editor`（最後）
